<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ff5722" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />
  <style>
    /* ... Tu CSS sin cambios ... */
  </style>
</head>
<body>

<!-- ... Tu HTML sin cambios ... -->

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
  import { getDatabase, ref, onValue, set, get } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyDZOGHFPrx52Hx1qUKPU_c6VpiGvrHL0_k",
    authDomain: "reserva-de-bahias.firebaseapp.com",
    databaseURL: "https://reserva-de-bahias-default-rtdb.firebaseio.com",
    projectId: "reserva-de-bahias",
    storageBucket: "reserva-de-bahias.firebasestorage.app",
    messagingSenderId: "506659561186",
    appId: "1:506659561186:web:85ddac2764073d21dbc8bb"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(registration => console.log('Service Worker registrado con éxito:', registration))
        .catch(error => console.log('Error al registrar el Service Worker:', error));
    });
  }

  function mostrarMensaje(texto, tipo) {
    const msg = document.getElementById("mensaje");
    msg.textContent = texto;
    msg.className = tipo;
    msg.style.display = "block";
    setTimeout(() => msg.style.display = "none", 3000);
  }

  async function cargarBahias(bahiaReservada) {
    try {
      const bahiasRef = ref(db, 'bahias');
      onValue(bahiasRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) {
          mostrarMensaje("No se encontraron bahías", "error");
          return;
        }

        const cont = document.getElementById('contenedor');
        cont.innerHTML = '';

        const instaladores = data.instaladores || {};
        // Obtener sólo las claves de bahías (excluyendo "instaladores")
        const bahiaKeys = Object.keys(data).filter(key => key !== 'instaladores');
        bahiaKeys.sort((a, b) => parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,'')));

        bahiaKeys.forEach(key => {
          const b = { nombre: key, ...data[key] };

          const div = document.createElement('div');
          div.className = 'bahia ' + (b.estado === 'Libre' ? 'libre' : 'ocupada');

          const bahiaDiv = document.createElement('div');
          bahiaDiv.className = 'nombre-bahia';
          bahiaDiv.textContent = b.nombre;
          div.appendChild(bahiaDiv);

          if (b.estado === 'Ocupada' && b.instalador) {
            const instDiv = document.createElement('div');
            instDiv.className = 'nombre-instalador';
            instDiv.textContent = b.instalador;
            div.appendChild(instDiv);

            // Obtener foto del instalador con padding 3 dígitos
            const claveInstalador = String(b.instalador).padStart(3, '0');
            const fotoUrl = instaladores[claveInstalador] || '';

            console.log(`Bahía ${b.nombre} - Instalador: ${b.instalador} - Foto URL:`, fotoUrl);

            if (fotoUrl) {
              const img = document.createElement('img');
              img.className = 'foto-instalador';
              img.src = fotoUrl;
              img.alt = `Foto de ${b.instalador}`;
              div.appendChild(img);
            }
          }

          if (b.estado === 'Libre') {
            div.onclick = async () => {
              const input = document.getElementById('instalador');
              const instalador = input.value.trim();
              if (!instalador) {
                input.classList.add('error');
                setTimeout(() => input.classList.remove('error'), 300);
                mostrarMensaje("Por favor ingresa tu número de instalador", "error");
                return;
              }

              try {
                const bahiaRef = ref(db, `bahias/${b.nombre}`);
                const snapshot = await get(bahiaRef);
                if (snapshot.val()?.estado === 'Libre') {
                  await set(bahiaRef, {
                    estado: 'Ocupada',
                    instalador: instalador
                    // No guardamos fotoUrl aquí, se obtiene de instaladores al cargar
                  });
                  mostrarMensaje(`Reservaste ${b.nombre}`, "ok");
                  input.value = '';
                } else {
                  mostrarMensaje("Esa bahía ya fue ocupada", "error");
                }
              } catch (error) {
                console.error('Error al reservar la bahía:', error);
                mostrarMensaje("Error al reservar la bahía", "error");
              }
            };
          }

          if (bahiaReservada && b.nombre === bahiaReservada) {
            div.classList.add('flash-pop');
          }

          cont.appendChild(div);
        });
      }, { onlyOnce: false });
    } catch (error) {
      console.error('Error en cargarBahias:', error);
      mostrarMensaje("Error al cargar las bahías", "error");
    }
  }

  document.getElementById('liberarBahias').addEventListener('click', async () => {
    const passwordInput = document.getElementById('passwordInput');
    const password = passwordInput.value.trim();

    if (password !== 'bc1516') {
      mostrarMensaje('Contraseña incorrecta', 'error');
      passwordInput.value = '';
      return;
    }

    try {
      const bahiasRef = ref(db, 'bahias');
      const snapshot = await get(bahiasRef);
      const bahias = snapshot.val() || {};
      let liberadas = 0;

      Object.keys(bahias).forEach(key => {
        if (key !== 'instaladores' && bahias[key].estado === 'Ocupada') {
          set(ref(db, `bahias/${key}`), {
            estado: 'Libre',
            instalador: ''
          });
          liberadas++;
        }
      });

      if (liberadas > 0) {
        mostrarMensaje(`Se liberaron ${liberadas} bahías`, 'ok');
      } else {
        mostrarMensaje('No hay bahías ocupadas para liberar', 'error');
      }
      passwordInput.value = '';
    } catch (error) {
      console.error('Error al liberar bahías:', error);
      mostrarMensaje('Error al liberar bahías', 'error');
      passwordInput.value = '';
    }
  });

  cargarBahias();
</script>

</body>
</html>





